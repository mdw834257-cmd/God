
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HopWeb Ultimate AI</title>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <!-- Markdown Parser for AI Code -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --bg-color: #f7f7f7;
            --card-color: #ffffff;
            --text-main: #333333;
            --text-sub: #666666;
            --accent-blue: #2196F3;
            --project-bg: #e0e0e0;
            --border-color: #ddd;
            --nav-bg: #ffffff;
            --danger-color: #ff4444;
            --editor-bg: #ffffff;
            --gutter-bg: #f0f0f0;
            --gutter-text: #999;
            --console-bg: #1e1e1e;
            --console-text: #00ff00;
            --switch-off: #ccc;
            --switch-on: #2196F3;
            --apk-card-bg: #e8e8e8;
            /* AI Gradient Colors */
            --ai-gradient: linear-gradient(135deg, #1e88e5, #9c27b0);
        }

        /* DARK MODE COLORS */
        body.dark-mode {
            --bg-color: #121212;
            --card-color: #1e1e1e;
            --text-main: #ffffff;
            --text-sub: #aaaaaa;
            --project-bg: #2c2c2c;
            --border-color: #333;
            --nav-bg: #1e1e1e;
            --editor-bg: #1e1e1e;
            --gutter-bg: #252525;
            --gutter-text: #666;
            --apk-card-bg: #2c2c2c;
            --switch-off: #555;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; }

        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: 0.3s;
            user-select: none; 
        }

        /* --- PAGES LAYOUT --- */
        .page {
            flex: 1; display: none;
            flex-direction: column; width: 100%; height: 100%;
            overflow: hidden; position: relative;
        }

        /* --- AUTH PAGE STYLES --- */
        #authPage {
            display: flex; justify-content: center; align-items: center; padding: 20px;
            background: var(--bg-color); z-index: 2000;
        }
        .auth-card {
            background: var(--card-color); width: 100%; max-width: 400px;
            padding: 30px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        .auth-logo { text-align: center; margin-bottom: 20px; }
        .auth-logo i { font-size: 50px; color: var(--accent-blue); margin-bottom: 10px; }
        .auth-title { font-size: 24px; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .auth-input-group { position: relative; margin-bottom: 15px; }
        .auth-input { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-color); color: var(--text-main); outline: none; transition: 0.3s; }
        .auth-input:focus { border-color: var(--accent-blue); }
        .eye-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); cursor: pointer; color: var(--text-sub); }
        .auth-btn { width: 100%; padding: 12px; background: var(--accent-blue); color: white; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3); }
        .auth-switch { text-align: center; margin-top: 20px; font-size: 14px; color: var(--text-sub); }
        .auth-switch span { color: var(--accent-blue); cursor: pointer; font-weight: bold; }
        .name-row { display: flex; gap: 10px; }

        /* --- SIDEBAR --- */
        .sidebar {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background: var(--card-color); z-index: 1500; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 5px 0 15px rgba(0,0,0,0.1); display: flex; flex-direction: column;
        }
        .sidebar.active { left: 0; }
        .sb-header { padding: 30px 20px; background: var(--accent-blue); color: white; }
        .user-avatar { width: 60px; height: 60px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px; color: var(--accent-blue); margin-bottom: 10px; }
        .sb-username { font-size: 18px; font-weight: bold; }
        .sb-uid { font-size: 13px; opacity: 0.9; margin-top: 5px; font-family: monospace; background: rgba(0,0,0,0.1); padding: 2px 6px; border-radius: 4px; display: inline-block; }
        .sb-menu { flex: 1; padding: 10px 0; overflow-y: auto; }
        .sb-item { padding: 15px 20px; display: flex; align-items: center; gap: 15px; color: var(--text-main); cursor: pointer; transition: 0.2s; }
        .sb-item:active { background: rgba(0,0,0,0.05); }
        .sb-item i { width: 25px; text-align: center; color: var(--text-sub); }
        .sidebar-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1400; display: none; backdrop-filter: blur(2px); }

        /* --- HEADER & NOTIFICATIONS --- */
        .header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; }
        .header-left { display: flex; align-items: center; gap: 20px; }
        .header-right { display: flex; align-items: center; gap: 20px; position: relative; }
        .menu-btn { font-size: 22px; cursor: pointer; color: var(--text-main); }
        .notif-btn { font-size: 20px; cursor: pointer; color: var(--text-main); position: relative; }
        
        .notif-badge { 
            position: absolute; 
            top: -8px; 
            right: -8px; 
            min-width: 16px; 
            height: 16px; 
            background: red; 
            color: white;
            border-radius: 50%; 
            border: 1px solid var(--bg-color); 
            font-size: 10px;
            font-weight: bold;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 2px;
        }
        
        #cloudStatus { font-size: 14px; display: flex; align-items: center; gap: 5px; color: var(--text-sub); font-weight: bold; }
        .cloud-dot { width: 10px; height: 10px; border-radius: 50%; background: #999; display: inline-block; }

        .logo-area { margin-top: 10px; margin-bottom: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .logo-text { font-size: 28px; font-weight: bold; color: var(--accent-blue); }

        /* --- BUTTONS --- */
        .create-btn {
            background-color: var(--card-color); border: 1px solid var(--border-color);
            color: var(--text-main); padding: 12px 30px; border-radius: 50px;
            display: flex; align-items: center; gap: 10px; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-size: 16px; margin: 0 auto 20px auto;
        }
        #projectListContainer { width: 100%; display: flex; flex-direction: column; align-items: center; gap: 12px; overflow-y: auto; padding-bottom: 80px; width: 100%; }
        .project-card {
            background-color: var(--project-bg); width: 90%; max-width: 400px;
            padding: 15px; border-radius: 12px; display: flex; align-items: center; gap: 15px;
            cursor: pointer; transition: 0.2s; position: relative;
        }
        .project-card:active { transform: scale(0.98); }
        .p-icon-box i { font-size: 30px; color: var(--accent-blue); }
        .p-info { display: flex; flex-direction: column; }
        .p-name { font-size: 16px; font-weight: 500; color: var(--text-main); }
        .p-date { font-size: 12px; color: var(--text-sub); }

        /* --- FILE MANAGER --- */
        .fm-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; }
        .fm-title { font-size: 24px; font-weight: 500; }
        .close-icon { font-size: 28px; cursor: pointer; color: var(--text-main); }
        .action-row { display: flex; gap: 15px; padding: 0 20px; margin-bottom: 25px; }
        .act-btn {
            flex: 1; height: 80px; border-radius: 15px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            color: white; font-weight: bold; font-size: 14px; cursor: pointer;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .btn-green { background-color: #4CAF50; } .btn-orange { background-color: #E67E00; }
        .round-icon-bg { width: 30px; height: 30px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .fm-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 0 20px 15px 20px; }
        .tool-icons { display: flex; gap: 20px; font-size: 20px; color: var(--text-main); align-items: center; }
        .tool-icons i { cursor: pointer; }
        
        /* GEMINI AI ICON STYLE */
        .ai-star-btn {
            font-size: 24px;
            background: linear-gradient(135deg, #4285F4, #9C27B0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            transition: transform 0.3s;
        }
        .ai-star-btn:active { transform: scale(1.2) rotate(15deg); }

        #searchContainer { display: none; padding: 0 20px 10px 20px; }
        #searchInput { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--card-color); color: var(--text-main); outline: none; }
        .file-list-container { background-color: var(--project-bg); flex: 1; margin: 0 20px 20px 20px; border-radius: 20px; padding: 10px; overflow-y: auto; }
        .file-item { display: flex; align-items: center; gap: 15px; padding: 15px; border-bottom: 1px solid rgba(0,0,0,0.05); background: transparent; transition: background 0.2s; border-radius: 10px; }
        .file-item:active { background: rgba(0,0,0,0.1); } 
        .f-icon { font-size: 28px; } .f-blue { color: #2196F3; } .f-grey { color: #555; }
        .f-info { flex: 1; } .f-name { font-size: 16px; color: var(--text-main); margin-bottom: 2px; } .f-date { font-size: 12px; color: var(--text-sub); }
        .f-actions { display: flex; gap: 15px; color: var(--text-sub); font-size: 18px; } .f-actions i { cursor: pointer; padding: 5px; }

        /* --- AI CHAT MODAL --- */
        #aiModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 2500; display: none;
            backdrop-filter: blur(5px);
            align-items: center; justify-content: center;
        }
        .ai-window {
            width: 90%; max-width: 500px; height: 80%;
            background: var(--card-color); border-radius: 20px;
            display: flex; flex-direction: column;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }
        .ai-w-header {
            padding: 15px; background: var(--ai-gradient); color: white;
            display: flex; justify-content: space-between; align-items: center;
            font-weight: bold; font-size: 18px;
        }
        .ai-w-body {
            flex: 1; padding: 15px; overflow-y: auto;
            background: var(--bg-color); display: flex; flex-direction: column; gap: 15px;
        }
        .ai-msg {
            padding: 10px 15px; border-radius: 15px; max-width: 85%;
            font-size: 14px; line-height: 1.5; word-wrap: break-word;
        }
        .ai-bot { background: var(--card-color); border: 1px solid var(--border-color); align-self: flex-start; color: var(--text-main); }
        .ai-user { background: #2196F3; color: white; align-self: flex-end; box-shadow: 0 2px 5px rgba(33,150,243,0.3); }
        .ai-w-input {
            padding: 10px; background: var(--card-color); border-top: 1px solid var(--border-color);
            display: flex; gap: 10px;
        }
        .ai-in { flex: 1; padding: 12px; border-radius: 50px; border: 1px solid var(--border-color); outline: none; background: var(--bg-color); color: var(--text-main); }
        .ai-send { width: 45px; height: 45px; border-radius: 50%; background: var(--ai-gradient); color: white; border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        
        /* Markdown Code Blocks in AI Chat */
        .ai-code-block {
            background: #1e1e1e; color: #fff; padding: 10px; border-radius: 8px;
            font-family: monospace; margin-top: 5px; overflow-x: auto; white-space: pre-wrap;
            position: relative;
        }
        .save-code-btn {
            display: block; width: 100%; margin-top: 5px;
            background: #4CAF50; color: white; border: none;
            padding: 8px; border-radius: 5px; cursor: pointer; font-weight: bold;
        }

        /* --- EDITOR PAGE --- */
        .editor-top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--card-color); border-bottom: 1px solid var(--border-color); }
        .ed-title { font-size: 18px; font-weight: bold; } .ed-subtitle { font-size: 12px; color: var(--text-sub); }
        .ed-icons { display: flex; gap: 20px; color: var(--text-sub); font-size: 18px; }
        #saveBtn { transition: 0.3s; }
        
        .editor-tab-row { padding: 10px 15px; background: var(--bg-color); display: flex; align-items: center; }
        .file-tab { background: #666; color: white; padding: 5px 15px; border-radius: 20px; font-size: 12px; display: flex; gap: 5px; align-items: center; }

        .editor-container { flex: 1; display: flex; position: relative; overflow: hidden; background: var(--editor-bg); }
        .gutter { width: 45px; background: var(--gutter-bg); color: var(--gutter-text); text-align: right; padding: 10px 5px; font-family: monospace; font-size: 14px; line-height: 24px; user-select: none; border-right: 1px solid var(--border-color); overflow: hidden; }
        .code-area { flex: 1; background: transparent; color: var(--text-main); border: none; outline: none; padding: 10px; font-family: monospace; font-size: 14px; line-height: 24px; white-space: pre; overflow: auto; resize: none; user-select: text; }

        .editor-bottom-bar { height: 50px; background: var(--card-color); border-top: 1px solid var(--border-color); display: flex; align-items: center; padding: 0 10px; gap: 10px; }
        .func-btn { font-size: 12px; font-weight: bold; color: var(--text-main); margin-right: 10px; }
        .symbol-scroller { flex: 1; overflow-x: auto; display: flex; gap: 15px; align-items: center; scrollbar-width: none; }
        .sym-key { font-family: monospace; font-size: 16px; color: var(--text-main); padding: 5px; cursor: pointer; }
        .run-btn-box { width: 40px; height: 40px; background: #e0e0e0; border-radius: 5px; display: flex; align-items: center; justify-content: center; cursor: pointer; } .run-btn-box i { color: #4CAF50; font-size: 18px; }

        .editor-menu { position: absolute; top: 50px; right: 10px; width: 200px; background: white; border-radius: 5px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); display: none; z-index: 200; }
        .em-item { padding: 12px 20px; font-size: 14px; color: #333; cursor: pointer; border-bottom: 1px solid #eee; }

        /* --- DRAGGABLE DEBUGGER --- */
        #floatingDebugBtn {
            position: fixed; width: 55px; height: 55px;
            background: rgba(33, 150, 243, 0.9); color: white; border-radius: 50%;
            display: none; align-items: center; justify-content: center;
            font-size: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.4);
            z-index: 1000; cursor: pointer; backdrop-filter: blur(4px);
            bottom: 80px; right: 20px; touch-action: none; transition: transform 0.1s;
        }
        #floatingDebugBtn:active { transform: scale(0.90); }
        #floatingDebugBtn.active { background: #FF5722; box-shadow: 0 0 15px rgba(255, 87, 34, 0.5); border: 2px solid white; }

        #debugConsolePanel {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 40%;
            background: #121212; color: #00ff00; z-index: 1001;
            display: none; flex-direction: column; border-top: 3px solid #333;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.8);
        }
        .console-header { padding: 10px 15px; background: #252525; color: white; font-size: 14px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #444; }
        .console-body { flex: 1; padding: 15px; font-family: 'Courier New', monospace; font-size: 13px; overflow-y: auto; white-space: pre-wrap; line-height: 1.5; background: #121212; }
        .log-error { color: #ff5252; background: rgba(255, 0, 0, 0.1); padding: 8px; margin-bottom: 5px; border-radius: 4px; border-left: 3px solid #ff5252; }
        .log-success { color: #4CAF50; padding: 8px; font-weight: bold; border-left: 3px solid #4CAF50; background: rgba(76, 175, 80, 0.1); margin-bottom: 5px; border-radius: 4px;}
        .log-info { color: #aaa; padding: 5px 0; }

        /* --- FIND & REPLACE BAR --- */
        #findReplaceBar { display: none; background: var(--card-color); border-top: 1px solid var(--border-color); padding: 10px; }
        .fr-row { display: flex; gap: 10px; margin-bottom: 5px; }
        .fr-input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 5px; outline: none; background: var(--bg-color); color: var(--text-main); font-size: 14px;}
        .fr-btn { padding: 8px 15px; background: transparent; border: none; font-weight: bold; color: var(--text-sub); cursor: pointer; font-size: 12px; text-transform: uppercase; }
        .fr-btn:active { color: var(--accent-blue); }

        /* --- PUBLISH PAGE --- */
        #publishPage { padding: 20px; overflow-y: auto; }
        .pub-header { font-size: 24px; font-weight: bold; margin-bottom: 20px; color: var(--accent-blue); text-align: center; }
        .pub-form { background: var(--card-color); padding: 20px; border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .pub-label { font-size: 14px; color: var(--text-sub); margin-bottom: 5px; display: block; }
        .pub-input { width: 100%; padding: 10px; background: var(--bg-color); border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 20px; color: var(--text-main); outline: none; }
        .pub-btn { width: 100%; background: var(--accent-blue); color: white; padding: 15px; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; }
        .pub-result { margin-top: 20px; text-align: center; word-break: break-all; }
        .pub-result a { color: var(--accent-blue); font-weight: bold; }
        .copy-link-btn { display: inline-block; margin-top: 15px; background: #4CAF50; color: white; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-size: 14px; cursor: pointer; border: none; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .copy-link-btn:active { background: #45a049; transform: scale(0.98); }

        /* --- NOTIFICATION FULL PAGE --- */
        #notificationPage { padding: 20px; overflow-y: auto; padding-bottom: 80px; }
        .notif-full-card { background: var(--card-color); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color); margin-bottom: 10px; }
        .nfc-title { font-weight: bold; font-size: 16px; margin-bottom: 5px; color: var(--accent-blue); }
        .nfc-msg { font-size: 14px; color: var(--text-main); margin-bottom: 10px; line-height: 1.4; }
        .nfc-time { font-size: 10px; color: var(--text-sub); text-align: right; }

        /* --- HISTORY PAGE CSS --- */
        .history-list { display: flex; flex-direction: column; gap: 15px; padding-bottom: 80px; }
        .history-card { background: var(--card-color); padding: 15px; border-radius: 10px; border: 1px solid var(--border-color); display: flex; flex-direction: column; gap: 5px; }
        .h-header { display: flex; justify-content: space-between; align-items: center; }
        .h-site-name { font-weight: bold; font-size: 16px; color: var(--accent-blue); }
        .h-date { font-size: 12px; color: var(--text-sub); }
        .h-file-name { font-size: 13px; color: var(--text-main); }
        .h-link-row { display: flex; align-items: center; gap: 10px; margin-top: 5px; background: var(--bg-color); padding: 8px; border-radius: 5px; }
        .h-link-text { flex: 1; font-size: 12px; color: var(--text-sub); overflow: hidden; white-space: nowrap; text-overflow: ellipsis; }
        .h-copy-icon { color: var(--text-main); cursor: pointer; padding: 5px; }

        /* --- RUN PAGE --- */
        #runPage iframe { width: 100%; flex: 1; border: none; background: white; }
        .run-header { padding: 10px; background: #333; color: white; display: flex; justify-content: space-between; align-items: center; }

        /* --- WEB TO APK PAGE CSS --- */
        #webToApkPage { overflow-y: auto; background: var(--bg-color); padding-bottom: 50px; }
        .apk-header { padding: 20px; text-align: center; }
        .apk-logo { font-size: 50px; color: #3DDC84; margin-bottom: 10px; }
        .apk-title { font-size: 22px; font-weight: bold; color: var(--text-main); margin-bottom: 5px; }
        .apk-container { padding: 0 20px; display: flex; flex-direction: column; gap: 15px; }
        
        /* APK Cards */
        .apk-card { background: var(--apk-card-bg); border-radius: 15px; padding: 20px; display: flex; flex-direction: column; gap: 15px; border: 1px solid rgba(0,0,0,0.05); }
        .apk-card-title { font-size: 12px; color: #2196F3; margin-bottom: 5px; font-weight: bold; }
        
        /* Image Picker */
        .icon-picker { display: flex; justify-content: center; align-items: center; margin: 10px 0; }
        .icon-preview { width: 80px; height: 80px; background: var(--card-color); border-radius: 15px; display: flex; align-items: center; justify-content: center; border: 2px dashed var(--border-color); cursor: pointer; overflow: hidden; position: relative; }
        .icon-preview img { width: 100%; height: 100%; object-fit: cover; }
        .icon-preview i { font-size: 24px; color: var(--text-sub); }
        
        /* Inputs */
        .apk-input-group { margin-bottom: 10px; }
        .apk-label { font-size: 12px; color: var(--text-sub); margin-bottom: 3px; display: block; }
        .apk-input { width: 100%; padding: 8px 0; background: transparent; border: none; border-bottom: 1px solid #999; color: var(--text-main); font-size: 16px; outline: none; }
        .apk-input:focus { border-bottom-color: #2196F3; }

        /* Toggles / Switches */
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .toggle-row:last-child { border-bottom: none; }
        .toggle-label { font-size: 14px; color: var(--text-main); }
        .switch { position: relative; display: inline-block; width: 40px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--switch-off); transition: .4s; border-radius: 20px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--switch-on); }
        input:checked + .slider:before { transform: translateX(20px); }

        .build-btn { margin: 20px; padding: 15px; background: #2196F3; color: white; border: none; border-radius: 50px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4); }

        /* --- SETTINGS/IDEASKY --- */
        .ideasky-container { padding: 20px; display: flex; flex-direction: column; align-items: center; overflow-y: auto;}
        .rec-title { font-size: 22px; margin-bottom: 20px; color: var(--text-main); }
        .android-card { background-color: black; color: white; width: 100%; max-width: 350px; height: 450px; border-radius: 25px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; position: relative; }
        .android-card h1 { font-size: 45px; margin-bottom: 10px; font-weight: normal; }
        .share-btn { margin-top: 30px; background: #25D366; color: white; border: none; padding: 15px 50px; border-radius: 50px; font-size: 18px; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .share-btn i { font-size: 20px; }

        .settings-header { padding: 20px; padding-top: 40px; display: flex; align-items: center; gap: 15px; }
        .back-btn { font-size: 24px; color: var(--text-sub); cursor: pointer; }
        .settings-list { padding: 0 20px; display: flex; flex-direction: column; gap: 15px; overflow-y: auto;}
        .setting-item { background: var(--card-color); padding: 20px; border-radius: 15px; display: flex; align-items: center; gap: 20px; cursor: pointer; border: 1px solid var(--border-color); }
        .s-icon { width: 30px; font-size: 22px; text-align: center; color: var(--text-main); }
        .s-text h4 { font-size: 16px; font-weight: 500; margin-bottom: 4px; color: var(--text-main); }
        .s-text p { font-size: 12px; color: var(--text-sub); }

        /* --- BOTTOM NAV --- */
        .bottom-nav { background-color: var(--nav-bg); padding: 10px 0; display: flex; justify-content: space-around; border-top: 1px solid var(--border-color); position: fixed; bottom: 0; width: 100%; z-index: 50; }
        .nav-item { color: var(--text-sub); font-size: 12px; display: flex; flex-direction: column; align-items: center; gap: 5px; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--accent-blue); }
        .nav-item.active i { transform: scale(1.1); }

        /* --- MODALS --- */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; z-index: 99; backdrop-filter: blur(2px); }
        .modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--card-color); width: 85%; max-width: 320px; padding: 25px; border-radius: 15px; display: none; z-index: 100; color: var(--text-main); }
        .custom-input { width: 100%; background: transparent; border: none; border-bottom: 1px solid #888; color: var(--text-main); padding: 5px 0; outline: none; margin: 15px 0; font-size: 16px; }
        .modal-footer { display: flex; justify-content: space-between; margin-top: 15px; }
        .btn-text { background: none; border: none; color: var(--accent-blue); font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-text-red { background: none; border: none; color: var(--danger-color); font-weight: bold; cursor: pointer; font-size: 14px; }
        .ctx-list { display: flex; flex-direction: column; gap: 10px; }
        .ctx-item { padding: 15px; display: flex; align-items: center; gap: 15px; cursor: pointer; border-bottom: 1px solid rgba(0,0,0,0.05); }
        .lang-option { padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; }
        #toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 30px; font-size: 14px; display: none; z-index: 2100; }
        #importFileInput { display: none; }
        #iconFileInput { display: none; }
        
        /* Loading Overlay for APK Build */
        #buildOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; display: none; align-items: center; justify-content: center; flex-direction: column; color: white; }
        
        /* Custom Animations */
        .build-anim { font-size: 50px; margin-bottom: 20px; color: #2196F3; display: flex; gap: 15px; justify-content: center; align-items: center; }
        .hammer-icon { animation: hammer-hit 0.5s infinite alternate; color: white; font-size: 40px; }
        @keyframes hammer-hit { 0% { transform: rotate(0deg); } 100% { transform: rotate(-45deg); } }
        @keyframes popIn { 0% { transform: scale(0); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <!-- === AUTH PAGE === -->
    <div id="authPage" class="page" style="display: flex;">
        <div class="auth-card">
            <div class="auth-logo">
                <i class="fas fa-cube"></i>
                <div class="logo-text">HopWeb Pro</div>
            </div>

            <!-- LOGIN FORM -->
            <div id="loginForm">
                <div class="auth-title">Welcome Back</div>
                <div class="auth-input-group">
                    <!-- Text type allows both email and phone -->
                    <input type="text" id="loginEmail" class="auth-input" placeholder="Email or Phone">
                </div>
                <div class="auth-input-group">
                    <input type="password" id="loginPass" class="auth-input" placeholder="Password">
                    <i class="fas fa-eye eye-icon" onclick="togglePassword('loginPass', this)"></i>
                </div>
                <button class="auth-btn" onclick="loginUser()">LOGIN</button>
                <div class="auth-switch">Don't have an account? <span onclick="switchAuthMode('register')">Sign Up</span></div>
            </div>

            <!-- REGISTER FORM -->
            <div id="registerForm" style="display: none;">
                <div class="auth-title">Create Account</div>
                <div class="name-row">
                    <div class="auth-input-group">
                        <input type="text" id="regFName" class="auth-input" placeholder="First Name">
                    </div>
                    <div class="auth-input-group">
                        <input type="text" id="regLName" class="auth-input" placeholder="Last Name">
                    </div>
                </div>
                <div class="auth-input-group">
                    <input type="text" id="regEmail" class="auth-input" placeholder="Email or Phone">
                </div>
                <div class="auth-input-group">
                    <input type="password" id="regPass" class="auth-input" placeholder="Password">
                    <i class="fas fa-eye eye-icon" onclick="togglePassword('regPass', this)"></i>
                </div>
                <div class="auth-input-group">
                    <input type="password" id="regPassConfirm" class="auth-input" placeholder="Confirm Password">
                    <i class="fas fa-eye eye-icon" onclick="togglePassword('regPassConfirm', this)"></i>
                </div>
                <button class="auth-btn" onclick="registerUser()">SIGN UP</button>
                <div class="auth-switch">Already have an account? <span onclick="switchAuthMode('login')">Login</span></div>
            </div>
        </div>
    </div>

    <!-- === SIDEBAR DRAWER === -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
    <div class="sidebar" id="sidebar">
        <div class="sb-header">
            <div class="user-avatar"><i class="fas fa-user"></i></div>
            <div class="sb-username" id="sbUsername">Guest</div>
            <div class="sb-uid" id="sbUid">UID: ...</div>
        </div>
        <div class="sb-menu">
            <div class="sb-item" onclick="toggleSidebar(); switchTab('home')"><i class="fas fa-home"></i> Home</div>
            <div class="sb-item" onclick="toggleSidebar(); switchTab('history')"><i class="fas fa-history"></i> Publishing History</div>
            <div class="sb-item" onclick="toggleSidebar(); switchTab('notifications')"><i class="fas fa-bell"></i> Notifications</div>
            <div class="sb-item" onclick="toggleSidebar(); openSettings()"><i class="fas fa-cog"></i> Settings</div>
            <hr style="border:0; border-top:1px solid #eee; margin:10px 0;">
            <div class="sb-item" onclick="logoutUser()" style="color: var(--danger-color);"><i class="fas fa-sign-out-alt" style="color: var(--danger-color);"></i> Logout</div>
        </div>
    </div>

    <!-- === 1. HOME PAGE === -->
    <div id="homePage" class="page">
        <div class="header">
            <div class="header-left">
                <i class="fas fa-bars menu-btn" onclick="toggleSidebar()"></i>
                <div id="cloudStatus"><div class="cloud-dot"></div> <span id="cloudText">Local</span></div>
            </div>
            <div class="header-right">
                <div class="notif-btn" onclick="switchTab('notifications')">
                    <i class="fas fa-bell"></i>
                    <div class="notif-badge" id="notifBadge">0</div>
                </div>
            </div>
        </div>
        
        <div class="logo-area"><i class="fas fa-folder-open" style="font-size: 40px; color: #2196F3;"></i><div class="logo-text">HopWeb</div></div>
        <button class="create-btn" onclick="openCreateModal()"><i class="fas fa-plus-circle" style="color: #2196F3;"></i><span id="txt_create">Create Project</span></button>
        <div id="projectListContainer"></div>
        <p id="emptyState" style="text-align:center; color:var(--text-sub);">No projects.<br>Click Create to start.</p>
    </div>

    <!-- === 2. FILE MANAGER === -->
    <div id="fileManagerPage" class="page" style="background: var(--bg-color);">
        <div class="fm-header"><div class="fm-title" id="fmProjectTitle">My Website</div><div class="close-icon" onclick="closeFileManager()"><i class="fas fa-times"></i></div></div>
        <div class="action-row">
            <div class="act-btn btn-green" onclick="webToApk()"><div class="round-icon-bg"><i class="fab fa-android"></i></div><span>Web to Apk</span></div>
            <div class="act-btn btn-orange" onclick="openPublishPage()"><div class="round-icon-bg"><i class="fas fa-arrow-up"></i></div><span>Publish to Web</span></div>
        </div>
        <div class="fm-toolbar">
            <h3>Website</h3>
            <div class="tool-icons">
                <!-- AI GEMINI STAR BUTTON ADDED HERE -->
                <i class="fas fa-star ai-star-btn" onclick="openAIModal()"></i>
                
                <i class="fas fa-search" onclick="toggleSearch()"></i>
                <i class="fas fa-plus" onclick="openCreateFileModal()"></i>
                <i class="fas fa-file-import" onclick="triggerImport()"></i>
            </div>
        </div>
        <div id="searchContainer"><input type="text" id="searchInput" placeholder="Search files..." onkeyup="filterFiles()"></div>
        <div class="file-list-container" id="fileListContainer"></div>
    </div>
    <input type="file" id="importFileInput" onchange="handleFileImport(this)">

    <!-- === 3. CODE EDITOR PAGE === -->
    <div id="editorPage" class="page">
        <div class="editor-top-bar">
            <div><div class="ed-title">HopWeb</div><div class="ed-subtitle" id="edFileName">1:1</div></div>
            <div class="ed-icons"><i class="fas fa-undo"></i><i class="fas fa-redo"></i><i class="fas fa-save" id="saveBtn" onclick="saveCode()"></i><i class="fas fa-ellipsis-v" onclick="toggleEditorMenu()"></i></div>
        </div>
        <div class="editor-menu" id="editorMenu">
            <div class="em-item" onclick="ctxFormat()">Format</div><div class="em-item" onclick="ctxJump()">Jump To Line</div><div class="em-item" onclick="ctxFind()">Find & Replace</div><div class="em-item" onclick="ctxDoc()">Document</div><div class="em-item" onclick="tryCloseEditor()">Close</div>
        </div>
        <div class="editor-tab-row"><div class="file-tab"><i class="fas fa-file-code"></i> <span id="tabName">index.html</span></div></div>
        <div class="editor-container"><div class="gutter" id="lineNumbers">1</div><textarea id="codeEditor" class="code-area" oninput="handleCodeInput()" onscroll="syncScroll()" spellcheck="false" nowrap></textarea></div>
        <div id="findReplaceBar">
            <div class="fr-row"><input type="text" id="findInput" class="fr-input" placeholder="Search"><button class="fr-btn" onclick="findNext()">NEXT</button></div>
            <div class="fr-row"><input type="text" id="repInput" class="fr-input" placeholder="Replace Text"><button class="fr-btn" onclick="replaceOne()">REP</button><button class="fr-btn" onclick="replaceAll()">REP ALL</button></div>
            <div style="text-align:center; border-top:1px solid #eee; padding-top:5px;"><button class="fr-btn" onclick="closeFindBar()">CLOSE</button></div>
        </div>
        <div class="editor-bottom-bar">
            <div class="func-btn">Func</div>
            <div class="symbol-scroller"><span class="sym-key" onclick="insertSymbol('<')">&lt;</span><span class="sym-key" onclick="insertSymbol('>')">&gt;</span><span class="sym-key" onclick="insertSymbol('{')">{</span><span class="sym-key" onclick="insertSymbol('}')">}</span><span class="sym-key" onclick="insertSymbol('(')">(</span><span class="sym-key" onclick="insertSymbol(')')">)</span><span class="sym-key" onclick="insertSymbol(';')">;</span><span class="sym-key" onclick="insertSymbol('=')">=</span><span class="sym-key" onclick="insertSymbol('/')">/</span><span class="sym-key" onclick="insertSymbol('&quot;')">"</span></div>
            <div class="run-btn-box" onclick="runCode()"><i class="fas fa-play"></i></div>
        </div>
    </div>

    <!-- === FLOATING DEBUGGER === -->
    <div id="floatingDebugBtn"><i class="fas fa-cog"></i></div>
    <div id="debugConsolePanel">
        <div class="console-header"><span>Debug Console</span><i class="fas fa-times" onclick="toggleDebugConsole(true)" style="cursor:pointer; padding:5px;"></i></div>
        <div class="console-body" id="consoleBody"></div>
    </div>
    <iframe id="syntaxCheckFrame" style="display:none;"></iframe>

    <!-- === 4. RUN PAGE === -->
    <div id="runPage" class="page" style="background: white;">
        <div class="run-header"><span>Browser Preview</span><i class="fas fa-times" onclick="closeRun()" style="font-size: 20px; cursor: pointer;"></i></div>
        <iframe id="previewFrame"></iframe>
    </div>

    <!-- === 5. PUBLISH PAGE === -->
    <div id="publishPage" class="page">
        <div class="header"><i class="fas fa-times" style="font-size:24px;" onclick="closePublishPage()"></i></div>
        <div class="pub-header">Host Website</div>
        <div class="pub-form">
            <label class="pub-label">Website Name (English Only)</label>
            <input type="text" id="pubSiteName" class="pub-input" placeholder="e.g. my-cool-page">
            <label class="pub-label">File to Upload (From Project)</label>
            <input type="text" id="pubFileName" class="pub-input" placeholder="e.g. index.html" value="index.html">
            <button class="pub-btn" onclick="handleAutoPublish()">PUBLISH NOW</button>
            <div id="pubResult" class="pub-result"></div>
        </div>
    </div>

    <!-- === 6. WEB TO APK PAGE === -->
    <div id="webToApkPage" class="page">
        <div class="header">
            <div class="header-left"><i class="fas fa-arrow-left menu-btn" onclick="closeWebToApk()"></i></div>
            <div class="header-right"></div>
        </div>
        <div class="apk-header">
            <i class="fab fa-android apk-logo"></i>
            <div class="apk-title">Convert to Android App</div>
            <div style="font-size:12px; color:var(--text-sub);">Create APK via GitHub Cloud Build</div>
        </div>

        <div class="apk-container">
            <!-- App Icon Card -->
            <div class="apk-card">
                <div class="apk-card-title">Application Icon</div>
                <div class="icon-picker" onclick="triggerIconUpload()">
                    <div class="icon-preview" id="apkIconPreview">
                        <i class="fas fa-image"></i>
                    </div>
                </div>
                <input type="file" id="iconFileInput" accept="image/*" onchange="handleIconUpload(this)">
            </div>

            <!-- App Info Card -->
            <div class="apk-card">
                <div class="apk-card-title">Application Details</div>
                
                <div class="apk-input-group">
                    <label class="apk-label">Application Name</label>
                    <input type="text" id="apkAppName" class="apk-input" value="MyWebApp">
                </div>

                <div class="apk-input-group">
                    <label class="apk-label">Package Name</label>
                    <input type="text" id="apkPkgName" class="apk-input" value="com.mycompany.webapp">
                </div>

                <div class="apk-input-group">
                    <label class="apk-label">Main File Name (e.g. index.html)</label>
                    <input type="text" id="apkMainFile" class="apk-input" value="index.html" placeholder="Type filename from project">
                    <div style="text-align:right; margin-top:5px;">
                        <span style="font-size:10px; color:#999;">Uses file from current project</span>
                    </div>
                </div>

                <div class="name-row">
                    <div class="apk-input-group" style="flex:1;">
                        <label class="apk-label">Version Name</label>
                        <input type="text" id="apkVerName" class="apk-input" value="1.0.0">
                    </div>
                    <div class="apk-input-group" style="flex:1;">
                        <label class="apk-label">Version Code</label>
                        <input type="number" id="apkVerCode" class="apk-input" value="1">
                    </div>
                </div>
            </div>

            <!-- Appearance Card -->
            <div class="apk-card">
                <div class="apk-card-title">Appearance</div>
                
                <div class="apk-input-group">
                    <label class="apk-label">Title Bar Color</label>
                    <div style="display:flex; align-items:center;">
                        <input type="color" id="apkColorPicker" value="#3F51B5" style="border:none; width:30px; height:30px; margin-right:10px; background:none;" onchange="updateColorText(this.value)">
                        <input type="text" id="apkColorText" class="apk-input" value="#3F51B5" oninput="updateColorPicker(this.value)">
                    </div>
                </div>
                
                 <div class="apk-input-group">
                    <label class="apk-label">Screen Rotation</label>
                    <select id="apkRotation" class="apk-input" style="background:var(--card-color);">
                        <option>Auto Rotate</option>
                        <option>Portrait</option>
                        <option>Landscape</option>
                    </select>
                </div>
            </div>

            <!-- Permissions Card -->
            <div class="apk-card">
                <div class="apk-card-title">Permissions & Features</div>
                
                <div class="toggle-row">
                    <span class="toggle-label">Internet Access (Turn off for offline app)</span>
                    <label class="switch"><input type="checkbox" id="permInternet" checked><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Allow Camera</span>
                    <label class="switch"><input type="checkbox" id="permCamera"><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Allow Microphone</span>
                    <label class="switch"><input type="checkbox" id="permMic"><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Allow Location</span>
                    <label class="switch"><input type="checkbox" id="permLoc"><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Storage Access</span>
                    <label class="switch"><input type="checkbox" id="permStorage" checked><span class="slider"></span></label>
                </div>
            </div>

            <!-- Advanced Options -->
             <div class="apk-card">
                <div class="apk-card-title">More Options</div>
                
                <div class="toggle-row">
                    <span class="toggle-label">Fullscreen Mode</span>
                    <label class="switch"><input type="checkbox" id="optFullscreen"><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Hide Title Bar</span>
                    <label class="switch"><input type="checkbox" id="optHideTitle"><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Show Loading UI</span>
                    <label class="switch"><input type="checkbox" id="optLoading" checked><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Allow Zoom</span>
                    <label class="switch"><input type="checkbox" id="optZoom" checked><span class="slider"></span></label>
                </div>
                <div class="toggle-row">
                    <span class="toggle-label">Pull to Refresh</span>
                    <label class="switch"><input type="checkbox" id="optRefresh" checked><span class="slider"></span></label>
                </div>
            </div>

            <button class="build-btn" onclick="triggerGitHubBuild()"><i class="fas fa-hammer"></i> START CLOUD BUILD</button>
        </div>
    </div>
    <div id="buildOverlay">
        <div class="spinner"></div>
        <div id="buildStatus">Initializing Cloud Build...</div>
    </div>

    <!-- === HISTORY PAGE === -->
    <div id="historyPage" class="page">
        <div class="header"><i class="fas fa-bars menu-btn" onclick="toggleSidebar()"></i></div>
        <div class="logo-area" style="margin-bottom: 10px;">
            <i class="fas fa-history" style="font-size: 40px; color: #2196F3;"></i>
            <div class="logo-text">Hosted History</div>
        </div>
        <div style="padding: 0 20px 10px 20px; text-align:center; color: var(--text-sub); font-size:12px;">Your published websites appear here.</div>
        <div id="historyListContainer" style="padding: 20px; overflow-y: auto; flex:1;"></div>
    </div>

    <!-- === NOTIFICATION PAGE (NEW) === -->
    <div id="notificationPage" class="page">
        <div class="header"><i class="fas fa-arrow-left menu-btn" onclick="switchTab('home')"></i></div>
        <div class="logo-area" style="margin-bottom: 10px;">
            <i class="fas fa-bell" style="font-size: 40px; color: #2196F3;"></i>
            <div class="logo-text">Notifications</div>
        </div>
        <div id="notificationList" style="padding: 20px;">
            <!-- Notifs injected here -->
            <div style="text-align:center; color:#999; margin-top:50px;">No new notifications.</div>
        </div>
    </div>

    <!-- === 6. SETTINGS & NAV === -->
    <div id="settingsPage" class="page">
        <div class="settings-header"><div class="back-btn" onclick="closeSettings()"><i class="fas fa-arrow-left"></i></div><i class="fas fa-cog" style="font-size: 35px; color: #2196F3;"></i><h2 id="txt_setTitle">Settings Panel</h2></div>
        <div class="settings-list">
            <div class="setting-item" onclick="editSymbols()"><div class="s-icon"><i class="fas fa-keyboard"></i></div><div class="s-text"><h4 id="txt_sym">Symbols Bar</h4><p id="txt_sym_desc">Edit symbols.</p></div></div>
            <div class="setting-item" onclick="autoFix()"><div class="s-icon"><i class="fas fa-tools"></i></div><div class="s-text"><h4 id="txt_debug">Debug Console</h4><p id="txt_debug_desc">Auto fix errors.</p></div></div>
            <div class="setting-item" onclick="clearCache()"><div class="s-icon"><i class="fas fa-broom"></i></div><div class="s-text"><h4 id="txt_cache">Clear Cache</h4><p id="txt_cache_desc">Delete projects.</p></div></div>
            
            <div class="setting-item" onclick="webToApk()"><div class="s-icon"><i class="fab fa-android"></i></div><div class="s-text"><h4 id="txt_apk">Web to Apk</h4><p id="txt_apk_desc">Convert to App.</p></div></div>
            
            <div class="setting-item" onclick="toggleTheme()"><div class="s-icon"><i class="fas fa-palette"></i></div><div class="s-text"><h4 id="txt_theme">Dark Mode Settings</h4><p id="txt_theme_desc">Tap to switch theme.</p></div></div>
        </div>
    </div>
    
    <div id="ideaSkyPage" class="page">
        <div class="header"><i class="fas fa-cog" onclick="openSettings()"></i></div>
        <div class="logo-area"><i class="fas fa-cloud" style="font-size: 40px; color: #2196F3;"></i><div class="logo-text">ideaSky</div></div>
        <div class="ideasky-container"><div class="rec-title">Recommendations</div><div class="android-card"><h1>HopWeb</h1><p>Share App with Friends.</p><button class="share-btn" onclick="shareApp()"><i class="fab fa-whatsapp"></i> SHARE ON WHATSAPP</button></div></div>
    </div>

    <!-- BOTTOM NAV -->
    <div class="bottom-nav" id="bottomNav">
        <div class="nav-item active" id="btnHome" onclick="switchTab('home')"><i class="fas fa-home"></i><span id="txt_nav_home">Home</span></div>
        <div class="nav-item" id="btnHistory" onclick="switchTab('history')"><i class="fas fa-clock"></i><span>History</span></div>
        <div class="nav-item" id="btnIdeaSky" onclick="switchTab('ideaSky')"><i class="fas fa-cloud"></i><span id="txt_nav_server">Server</span></div>
    </div>

    <!-- MODALS -->
    <div class="overlay" id="overlay"></div>
    <div class="modal" id="modalCreate"><h3 id="txt_modal_create">Create Project</h3><p style="font-size:12px; color:#2196F3; margin-top:10px;">Name</p><input type="text" id="pNameInput" class="custom-input" value="My Website"><div class="modal-footer"><button class="btn-text" onclick="closeModals()">CANCEL</button><button class="btn-text" onclick="createProject()">OK</button></div></div>
    <div class="modal" id="modalContext"><h3 id="ctxFileName">File Options</h3><div class="ctx-list"><div class="ctx-item" onclick="ctxRename()"><i class="fas fa-edit" style="color:#2196F3;"></i> Rename</div><div class="ctx-item" onclick="ctxDelete()"><i class="fas fa-trash" style="color:var(--danger-color);"></i> Delete</div></div><div class="modal-footer"><button class="btn-text" onclick="closeModals()">CLOSE</button></div></div>
    <div class="modal" id="modalProjectCtx"><h3 id="ctxProjectName">Project Options</h3><div class="ctx-list"><div class="ctx-item" onclick="deleteProject()"><i class="fas fa-trash" style="color:var(--danger-color);"></i> Delete Project</div></div><div class="modal-footer"><button class="btn-text" onclick="closeModals()">CLOSE</button></div></div>
    <div class="modal" id="modalRename"><h3>Rename File</h3><input type="text" id="renameInput" class="custom-input"><div class="modal-footer"><button class="btn-text" onclick="closeModals()">CANCEL</button><button class="btn-text" onclick="performRename()">SAVE</button></div></div>
    <div class="modal" id="modalUnsaved"><h3>Save your project?</h3><p style="color:#666; font-size:14px; margin-bottom:20px;">There are unsaved changes.</p><div class="modal-footer"><button class="btn-text" style="color:#666;" onclick="closeModals()">CANCEL</button><button class="btn-text" onclick="discardAndExit()">DISCARD</button><button class="btn-text" onclick="saveAndExit()">SAVE & EXIT</button></div></div>
    <div class="modal" id="modalCreateFile">
        <h3>Create New File</h3>
        <p style="font-size:12px; color:#2196F3; margin-top:10px;">Filename (e.g. style.css)</p>
        <input type="text" id="newFileNameInput" class="custom-input" placeholder="filename.html">
        <div class="modal-footer">
            <button class="btn-text" style="color:#666;" onclick="closeModals()">CANCEL</button>
            <button class="btn-text" onclick="performCreateFile()">CREATE</button>
        </div>
    </div>

    <!-- AI CHAT MODAL (POPUP) -->
    <div id="aiModal">
        <div class="ai-window">
            <div class="ai-w-header">
                <div><i class="fas fa-star" style="margin-right:10px;"></i>AI Assistant</div>
                <i class="fas fa-times" onclick="openAIModal()" style="cursor:pointer;"></i>
            </div>
            <div class="ai-w-body" id="aiChatBody">
                <div class="ai-msg ai-bot">
                    Hello! I am your coding AI. Ask me to write code, fix bugs, or explain concepts.
                </div>
            </div>
            <div class="ai-w-input">
                <input type="text" class="ai-in" id="aiInput" placeholder="Ask AI..." onkeydown="if(event.key === 'Enter') sendToOpenRouter()">
                <button class="ai-send" onclick="sendToOpenRouter()"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>
    </div>

    <div id="toast">Notification</div>

    <!-- ================= JAVASCRIPT ================= -->
    <script>
        // ============================================
        // !!! CONFIGURATION AREA !!!
        // ============================================
        
        const INTERNAL_APP_VERSION = 4;
        
        //  CHANGED: OpenRouter Key now loads from Firebase Admin
        var OPENROUTER_API_KEY = "";

        var ADMIN_CONFIG = {
            username: "mdw834257-cmd",         
            repo: "God",      
            token: "" 
        };

        const firebaseConfig = {
            apiKey: "AIzaSyDkE3_Ai4Q811HTrNRt5Jb5WWAHLQtpPFM",
            authDomain: "private-c291d.firebaseapp.com",
            databaseURL: "https://private-c291d-default-rtdb.firebaseio.com",
            projectId: "private-c291d",
            storageBucket: "private-c291d.firebasestorage.app",
            messagingSenderId: "293903896009",
            appId: "1:293903896009:web:514dc676aa36ba6a5f6c18",
            measurementId: "G-V7WCHBQ91Y"
        };
        // ============================================

        // GLOBALS
        var allProjects = [];
        var allFiles = {};
        var publishHistory = []; 
        var db = null; 
        var auth = null; 
        var currentUser = null; 
        var myNotifications = [];
        var shareLink = "https://hopweb.app"; 
        
        var currentProjectName = ""; 
        var currentOpenedFile = "";
        var currentTab = 'home';
        var isCodeDirty = false;
        var selectedFileElement = null; 
        var selectedFileName = "";
        var selectedProjectName = ""; 
        var isDarkMode = false; 
        var lastPublishedUrl = ""; 
        var currentIconBase64 = "";

        // DEFAULT TEMPLATE
        var defaultCode = `<!doctype html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>New Website</title>
        <style>
            body { background: #f0f0f0; color: #333; font-family: sans-serif; text-align: center; padding-top: 50px; }
            h1 { color: #2196F3; }
        </style>
    </head>
    <body>
        <h1>Hello World!</h1>
        <p>Created with HopWeb Ultimate.</p>
        <script>
            console.log("Welcome to HopWeb!");
        <\/script>
    </body>
</html>`;

        // --- INITIALIZATION ---
        window.onload = function() { 
            if(localStorage.getItem('hopweb_theme') === 'dark') {
                document.body.classList.add('dark-mode');
                isDarkMode = true;
            }

            try {
                if (firebase.apps.length === 0) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                db = firebase.firestore();
                auth = firebase.auth();
                
                loadSystemFeatures();
                loadApiSecrets(); // <-- Loads GitHub AND AI Keys

                auth.onAuthStateChanged((user) => {
                    if (user) {
                        currentUser = user;
                        document.getElementById('authPage').style.display = 'none';
                        document.getElementById('homePage').style.display = 'flex';
                        document.getElementById('bottomNav').style.display = 'flex';
                        updateSidebarInfo(user);
                        syncFromCloud(); 
                    } else {
                        currentUser = null;
                        allProjects = []; allFiles = {}; publishHistory = [];
                        document.getElementById('authPage').style.display = 'flex';
                        document.getElementById('homePage').style.display = 'none';
                        document.getElementById('bottomNav').style.display = 'none';
                        hideAllPages();
                        document.getElementById('authPage').style.display = 'flex';
                    }
                });

            } catch (e) {
                console.error("Firebase Init Error:", e);
                showToast("Firebase Config Error (Check Console)");
            }

            initDraggableGear();
        }

        // --- ADMIN SYSTEM LISTENER (AUTO UPDATES) ---
        function loadSystemFeatures() {
            db.collection("system_config").onSnapshot((snapshot) => {
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (doc.id === "app_settings" && data.appName) {
                        document.title = data.appName;
                        document.querySelectorAll('.logo-text').forEach(el => el.innerText = data.appName);
                    }
                    if (doc.id === "referral_settings" && data.link) {
                        shareLink = data.link;
                    }
                    if (doc.id === "app_update") {
                        const serverVerCode = data.versionCode;
                        if (serverVerCode > INTERNAL_APP_VERSION) {
                            let msg = "New Update Available: " + data.versionName;
                            if (data.forceUpdate) {
                                document.body.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100vh; background:#121212; color:white; text-align:center; padding:20px;">
                                    <h2 style="color:#2196F3; margin-bottom:10px;">Update Required</h2>
                                    <p>${data.updateMessage}</p>
                                    <button onclick="window.location.href='${data.downloadUrl}'" style="padding:15px 30px; background:#00C851; border:none; border-radius:50px; color:white; font-weight:bold; margin-top:20px; cursor:pointer;">DOWNLOAD UPDATE</button>
                                </div>`;
                            } else {
                                if(confirm(msg + "\nDownload now?")) {
                                    window.location.href = data.downloadUrl;
                                }
                            }
                        }
                    }
                    if (doc.id === "server_settings" && data.gameIp) {
                        localStorage.setItem("game_ip", data.gameIp);
                    }
                    // Secrets live-reload logic handled below
                });
            });

            const yesterday = new Date(new Date().getTime() - (24 * 60 * 60 * 1000));
            db.collection("system_notifications")
            .where("timestamp", ">", yesterday)
            .onSnapshot((snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === "added") {
                        const n = change.doc.data();
                        showToast(" Admin: " + n.title);
                        myNotifications.push({msg: n.title + ": " + n.message, date: "Just now"});
                        updateNotificationBadge();
                    }
                });
            });
        }
        
        //  NEW FUNCTION TO LOAD BOTH SECRETS
        function loadApiSecrets() {
            // 1. GitHub Token
            db.collection("system_config").doc("github_secrets").get()
            .then((doc) => {
                if (doc.exists && doc.data().token) {
                    ADMIN_CONFIG.token = doc.data().token;
                    console.log("System: Cloud Engine Connected");
                }
            });

            // 2. OpenRouter Key
            db.collection("system_config").doc("openrouter_secrets").get()
            .then((doc) => {
                if (doc.exists && doc.data().key) {
                    OPENROUTER_API_KEY = doc.data().key;
                    console.log("System: AI Brain Connected");
                } else {
                    console.log("System: AI Key Missing in DB");
                }
            });
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            if(isDarkMode) {
                document.body.classList.add('dark-mode');
                localStorage.setItem('hopweb_theme', 'dark');
            } else {
                document.body.classList.remove('dark-mode');
                localStorage.setItem('hopweb_theme', 'light');
            }
        }

        // --- AUTHENTICATION LOGIC ---
        function switchAuthMode(mode) {
            if(mode === 'register') {
                document.getElementById('loginForm').style.display = 'none';
                document.getElementById('registerForm').style.display = 'block';
            } else {
                document.getElementById('loginForm').style.display = 'block';
                document.getElementById('registerForm').style.display = 'none';
            }
        }

        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            if(input.type === "password") {
                input.type = "text";
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = "password";
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        function formatAuthInput(input) {
            if (/^\d+$/.test(input)) {
                return input + "@hopweb.user";
            }
            return input;
        }

        function registerUser() {
            const rawEmail = document.getElementById('regEmail').value.trim();
            const pass = document.getElementById('regPass').value;
            const confirm = document.getElementById('regPassConfirm').value;
            const fName = document.getElementById('regFName').value;
            const lName = document.getElementById('regLName').value;

            if(!rawEmail || !pass || !fName || !lName) { showToast("All fields required"); return; }
            if(pass !== confirm) { showToast("Passwords don't match"); return; }
            if(pass.length < 6) { showToast("Password must be 6+ chars"); return; }

            const finalEmail = formatAuthInput(rawEmail);

            auth.createUserWithEmailAndPassword(finalEmail, pass)
                .then((userCredential) => {
                    userCredential.user.updateProfile({
                        displayName: fName + " " + lName
                    }).then(() => {
                        const shortId = Math.floor(100000 + Math.random() * 900000);
                        
                        const initialData = {
                            customId: shortId,
                            emailOrPhone: rawEmail,
                            projects: "[]",
                            files: "{}",
                            history: "[]",
                            inbox: [],
                            isBlocked: false,
                            lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
                        };
                        
                        db.collection("hopweb_data").doc(userCredential.user.uid).set(initialData)
                        .then(() => {
                            showToast("Account Created!");
                            updateSidebarInfo(userCredential.user);
                        });
                    });
                })
                .catch((error) => {
                    showToast(error.message);
                });
        }

        function loginUser() {
            const rawEmail = document.getElementById('loginEmail').value.trim();
            const pass = document.getElementById('loginPass').value;
            if(!rawEmail || !pass) { showToast("Enter Email/Phone & Password"); return; }

            const finalEmail = formatAuthInput(rawEmail);

            auth.signInWithEmailAndPassword(finalEmail, pass)
                .then(() => {
                    showToast("Logged In");
                })
                .catch((error) => {
                    showToast("Failed: " + error.message);
                });
        }

        function logoutUser() {
            auth.signOut().then(() => {
                showToast("Logged Out");
                toggleSidebar();
            });
        }

        function updateSidebarInfo(user) {
            document.getElementById('sbUsername').innerText = user.displayName || "User";
            db.collection("hopweb_data").doc(user.uid).get().then((doc) => {
                if(doc.exists && doc.data().customId) {
                    document.getElementById('sbUid').innerText = "UID: " + doc.data().customId;
                } else {
                    document.getElementById('sbUid').innerText = "UID: " + user.uid.substring(0, 6);
                }
            });
        }

        function toggleSidebar() {
            const sb = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if(sb.classList.contains('active')) {
                sb.classList.remove('active');
                overlay.style.display = 'none';
            } else {
                sb.classList.add('active');
                overlay.style.display = 'block';
            }
        }
        
        // --- DATA SYNC ---
        function saveData() {
            if (!currentUser) return;
            updateCloudStatus("saving");
            
            const dataToSave = {
                projects: JSON.stringify(allProjects),
                files: JSON.stringify(allFiles),
                history: JSON.stringify(publishHistory),
                lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection("hopweb_data").doc(currentUser.uid).set(dataToSave, {merge: true})
            .then(() => {
                updateCloudStatus("connected");
                console.log("Cloud Saved");
            })
            .catch((err) => {
                console.error("Save Error", err);
                updateCloudStatus("error");
            });
        }

        function syncFromCloud() {
            if(!currentUser) return;
            updateCloudStatus("saving"); 
            
            db.collection("hopweb_data").doc(currentUser.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const d = doc.data();
                    if(d.isBlocked === true) {
                        alert(" Your account has been blocked by Admin.");
                        auth.signOut().then(() => location.reload());
                        return;
                    }

                    if(d.projects && typeof d.projects === 'string') allProjects = JSON.parse(d.projects);
                    if(d.files && typeof d.files === 'string') allFiles = JSON.parse(d.files);
                    if(d.history && typeof d.history === 'string') publishHistory = JSON.parse(d.history);
                    
                    if(d.inbox) {
                        const oldLength = myNotifications.length;
                        myNotifications = d.inbox;
                        if(myNotifications.length > oldLength && currentTab !== 'notifications') {
                            showToast("New Message from Admin!");
                            updateNotificationBadge();
                        }
                    }
                    
                    renderProjectList();
                    if(currentTab === 'history') renderHistory();
                    if(currentTab === 'notifications') renderNotifications();
                    updateCloudStatus("connected");
                }
            }, (error) => {
                console.log("Error getting document:", error);
                updateCloudStatus("error");
            });
        }

        function updateCloudStatus(status) {
            const dot = document.querySelector('.cloud-dot');
            const txt = document.getElementById('cloudText');
            
            if(status === 'connected') {
                dot.style.background = '#4CAF50';
                txt.innerText = 'Cloud Synced';
            } else if(status === 'saving') {
                dot.style.background = '#FFC107';
                txt.innerText = 'Syncing...';
            } else {
                dot.style.background = '#F44336';
                txt.innerText = 'Error';
            }
        }

        // --- NAVIGATION ---
        function switchTab(tab) {
            currentTab = tab;
            document.getElementById('btnHome').className = (tab === 'home') ? 'nav-item active' : 'nav-item';
            document.getElementById('btnHistory').className = (tab === 'history') ? 'nav-item active' : 'nav-item';
            document.getElementById('btnIdeaSky').className = (tab === 'ideaSky') ? 'nav-item active' : 'nav-item';
            
            hideAllPages();
            
            if(tab === 'home') {
                document.getElementById('homePage').style.display = 'flex';
                renderProjectList();
            }
            if(tab === 'history') { 
                document.getElementById('historyPage').style.display = 'flex';
                renderHistory();
            }
            if(tab === 'notifications') {
                document.getElementById('notificationPage').style.display = 'flex';
                document.getElementById('notifBadge').style.display = 'none';
                renderNotifications();
            }
            if(tab === 'ideaSky') document.getElementById('ideaSkyPage').style.display = 'flex';
            document.getElementById('bottomNav').style.display = 'flex';
            
            document.getElementById('floatingDebugBtn').style.display = 'none';
            document.getElementById('debugConsolePanel').style.display = 'none';
        }
        function hideAllPages() { document.querySelectorAll('.page').forEach(p => p.style.display = 'none'); }
        function openSettings() { hideAllPages(); document.getElementById('settingsPage').style.display = 'flex'; document.getElementById('bottomNav').style.display = 'none'; }
        function closeSettings() { switchTab('home'); }

        // --- NOTIFICATION RENDER & BADGE ---
        function updateNotificationBadge() {
            const count = myNotifications.length;
            const badge = document.getElementById('notifBadge');
            
            if(count > 0 && currentTab !== 'notifications') {
                badge.style.display = 'flex';
                badge.innerText = count > 9 ? '9+' : count;
            } else {
                badge.style.display = 'none';
            }
        }

        function renderNotifications() {
            const container = document.getElementById('notificationList');
            container.innerHTML = "";
            if(myNotifications.length === 0) {
                container.innerHTML = '<div style="text-align:center; color:#999; margin-top:50px;">No new notifications.</div>';
                return;
            }
            const list = [...myNotifications].reverse();
            list.forEach(n => {
                const div = document.createElement('div');
                div.className = 'notif-full-card';
                div.innerHTML = `<div class="nfc-title">Message from Admin</div><div class="nfc-msg">${n.msg}</div><div class="nfc-time">${n.date}</div>`;
                container.appendChild(div);
            });
        }

        // --- PROJECT MANAGEMENT ---
        function renderProjectList() {
            const container = document.getElementById('projectListContainer');
            container.innerHTML = "";
            if(allProjects.length === 0) {
                document.getElementById('emptyState').style.display = 'block';
                return;
            }
            document.getElementById('emptyState').style.display = 'none';

            allProjects.forEach(proj => {
                const div = document.createElement('div');
                div.className = 'project-card';
                div.innerHTML = `
                    <div class="p-icon-box"><i class="fas fa-folder"></i></div>
                    <div class="p-info"><div class="p-name">${proj.name}</div><div class="p-date">${proj.date}</div></div>`;
                div.onclick = () => openFileManager(proj.name);
                addLongPressEvent(div, () => openProjectContext(proj.name));
                container.appendChild(div);
            });
        }

        function createProject() {
            const name = document.getElementById('pNameInput').value.trim();
            if(!name) return;
            if(allProjects.some(p => p.name === name)) { showToast("Name already exists!"); return; }
            const now = new Date().toISOString().slice(0,10);
            allProjects.push({ name: name, date: now });
            allFiles[name] = { "index.html": defaultCode };
            saveData(); renderProjectList(); closeModals(); showToast("Project Created");
        }

        function openProjectContext(name) { selectedProjectName = name; document.getElementById('ctxProjectName').innerText = name; document.getElementById('overlay').style.display = 'block'; document.getElementById('modalProjectCtx').style.display = 'block'; if(navigator.vibrate) navigator.vibrate(50); }

        function deleteProject() {
            if(confirm("Delete " + selectedProjectName + " and all its files?")) {
                allProjects = allProjects.filter(p => p.name !== selectedProjectName);
                delete allFiles[selectedProjectName];
                saveData(); renderProjectList(); showToast("Project Deleted");
            }
            closeModals();
        }

        // --- FILE MANAGER ---
        function openFileManager(projName) {
            currentProjectName = projName; hideAllPages(); document.getElementById('bottomNav').style.display = 'none'; document.getElementById('fileManagerPage').style.display = 'block'; document.getElementById('fmProjectTitle').innerText = projName; renderFiles();
        }
        function closeFileManager() { switchTab('home'); currentProjectName = ""; }

        function renderFiles() {
            const container = document.getElementById('fileListContainer'); container.innerHTML = "";
            const files = allFiles[currentProjectName] || {};
            Object.keys(files).forEach(fileName => {
                const type = fileName.match(/\.(png|jpg|jpeg|gif)$/i) ? 'img' : 'code';
                addFileToDOM(fileName, "Just now", type);
            });
        }

        function addFileToDOM(name, date, type) {
            let icon = type==='img'?'fas fa-file-image':'fas fa-file-code';
            let col = type==='img'?'f-blue':'f-grey';
            let act = (type==='code' || name.endsWith('.html') || name.endsWith('.css') || name.endsWith('.js')) ? `onclick="openEditor('${name}')"` : "";
            const div = document.createElement('div'); div.className = 'file-item'; 
            div.innerHTML = `<div class="f-icon ${col}" ${act}><i class="${icon}"></i></div><div class="f-info" ${act}><div class="f-name">${name}</div><div class="f-date">${date}</div></div><div class="f-actions"><i class="fas fa-trash" onclick="askDeleteFile('${name}')"></i></div>`;
            addLongPressEvent(div, () => { selectedFileName=name; openContextMenu(div, name); });
            document.getElementById('fileListContainer').appendChild(div);
        }

        function handleFileImport(input) {
            if (input.files[0]) {
                const f = input.files[0]; const reader = new FileReader();
                if(f.type.startsWith('image/')) { reader.onload = function(e) { allFiles[currentProjectName][f.name] = e.target.result; saveData(); renderFiles(); showToast("Image Imported"); }; reader.readAsDataURL(f); } 
                else { reader.onload = function(e) { allFiles[currentProjectName][f.name] = e.target.result; saveData(); renderFiles(); showToast("File Imported"); }; reader.readAsText(f); }
            }
        }
        function askDeleteFile(name) { if(confirm("Delete " + name + "?")) { delete allFiles[currentProjectName][name]; saveData(); renderFiles(); showToast("Deleted"); } }
        function openContextMenu(el, n) { selectedFileElement = el; selectedFileName = n; document.getElementById('ctxFileName').innerText = n; document.getElementById('overlay').style.display = 'block'; document.getElementById('modalContext').style.display = 'block'; if(navigator.vibrate) navigator.vibrate(50); }
        function ctxRename() { document.getElementById('modalContext').style.display = 'none'; document.getElementById('modalRename').style.display = 'block'; document.getElementById('renameInput').value = selectedFileName; }
        function performRename() { 
            const newName = document.getElementById('renameInput').value.trim(); if(!newName) return;
            if(allFiles[currentProjectName][newName]) { showToast("Filename already exists!"); return; }
            const content = allFiles[currentProjectName][selectedFileName]; allFiles[currentProjectName][newName] = content;
            delete allFiles[currentProjectName][selectedFileName]; saveData(); renderFiles(); closeModals(); showToast("Renamed");
        }
        function ctxDelete() { if(confirm("Delete " + selectedFileName + "?")) { delete allFiles[currentProjectName][selectedFileName]; saveData(); renderFiles(); showToast("Deleted"); } closeModals(); }

        // --- EDITOR LOGIC ---
        function openEditor(fileName) {
            hideAllPages(); currentOpenedFile = fileName; document.getElementById('editorPage').style.display = 'flex'; document.getElementById('tabName').innerText = fileName;
            const content = allFiles[currentProjectName][fileName] || ""; document.getElementById('codeEditor').value = content; updateLineNumbers(); setDirty(false);
            const btn = document.getElementById('floatingDebugBtn'); btn.style.display = 'flex'; btn.style.left = 'auto'; btn.style.top = 'auto'; btn.style.right = '20px'; btn.style.bottom = '80px';
        }
        function handleCodeInput() { updateLineNumbers(); setDirty(true); }
        function setDirty(dirty) { isCodeDirty = dirty; const btn = document.getElementById('saveBtn'); if(dirty) { btn.style.color = 'var(--text-main)'; btn.style.opacity = '1'; } else { btn.style.color = 'var(--text-sub)'; btn.style.opacity = '0.5'; } }
        function saveCode() { if(currentOpenedFile && currentProjectName) { allFiles[currentProjectName][currentOpenedFile] = document.getElementById('codeEditor').value; saveData(); showToast("Saved"); setDirty(false); } }
        function runCode() { 
            const code = document.getElementById('codeEditor').value; document.getElementById('editorPage').style.display = 'none'; document.getElementById('floatingDebugBtn').style.display = 'none'; document.getElementById('runPage').style.display = 'flex'; 
            const frame = document.getElementById('previewFrame'); frame.src = "about:blank"; setTimeout(() => { const d = frame.contentDocument; d.open(); d.write(code); d.close(); }, 50);
        }
        function closeRun() { document.getElementById('runPage').style.display = 'none'; document.getElementById('editorPage').style.display = 'flex'; document.getElementById('floatingDebugBtn').style.display = 'flex'; }

        // --- DRAGGABLE DEBUGGER ---
        function initDraggableGear() {
            const el = document.getElementById('floatingDebugBtn');
            let isDragging = false, startX, startY, initialLeft, initialTop;
            el.addEventListener('touchstart', (e) => { isDragging = false; const t = e.touches[0]; startX = t.clientX; startY = t.clientY; const r = el.getBoundingClientRect(); el.style.right = 'auto'; el.style.bottom = 'auto'; el.style.left = r.left + 'px'; el.style.top = r.top + 'px'; initialLeft = r.left; initialTop = r.top; }, {passive: false});
            el.addEventListener('touchmove', (e) => { e.preventDefault(); const t = e.touches[0]; const dx = t.clientX - startX; const dy = t.clientY - startY; if (Math.abs(dx) > 10 || Math.abs(dy) > 10) isDragging = true; if (isDragging) { el.style.left = (initialLeft + dx) + 'px'; el.style.top = (initialTop + dy) + 'px'; } }, {passive: false});
            el.addEventListener('touchend', () => { if (!isDragging) toggleDebugConsole(); });
            el.addEventListener('mousedown', (e) => { isDragging = false; startX = e.clientX; startY = e.clientY; const r = el.getBoundingClientRect(); el.style.right = 'auto'; el.style.bottom = 'auto'; el.style.left = r.left + 'px'; el.style.top = r.top + 'px'; initialLeft = r.left; initialTop = r.top; const onMove = (mv) => { if(Math.abs(mv.clientX - startX) > 5) isDragging = true; if(isDragging) { el.style.left = (initialLeft + mv.clientX - startX) + 'px'; el.style.top = (initialTop + mv.clientY - startY) + 'px'; } }; const onUp = () => { document.removeEventListener('mousemove', onMove); document.removeEventListener('mouseup', onUp); if(!isDragging) toggleDebugConsole(); }; document.addEventListener('mousemove', onMove); document.addEventListener('mouseup', onUp); });
        }
        function toggleDebugConsole(forceClose = false) { const p = document.getElementById('debugConsolePanel'); const b = document.getElementById('floatingDebugBtn'); if(p.style.display === 'flex' || forceClose) { p.style.display = 'none'; b.classList.remove('active'); } else { p.style.display = 'flex'; b.classList.add('active'); analyzeCode(); } }
        function analyzeCode() {
            const code = document.getElementById('codeEditor').value; const logBody = document.getElementById('consoleBody'); logBody.innerHTML = "<div class='log-info'>Analyzing...</div>";
            if(!code.includes('<html') && !code.includes('<body')) logBody.innerHTML += "<div class='log-info'>Tip: Add &lt;html&gt; & &lt;body&gt;.</div>";
            const iframe = document.getElementById('syntaxCheckFrame'); const doc = iframe.contentDocument || iframe.contentWindow.document;
            const errorCatcher = `<script>window.onerror = function(msg, url, line, col, error) { window.parent.postMessage({type: 'error', msg: msg, line: line}, '*'); return true; };<\/script>`;
            let errorCount = 0;
            const handleMsg = (e) => { if(e.data && e.data.type === 'error') { errorCount++; logBody.innerHTML += `<div class='log-error'> ${e.data.msg} (Line ~${e.data.line || '?'})</div>`; } };
            window.addEventListener('message', handleMsg, {once: false});
            doc.open(); doc.write(errorCatcher + code); doc.close();
            setTimeout(() => { window.removeEventListener('message', handleMsg); if(errorCount === 0) logBody.innerHTML += "<div class='log-success'> No JS Errors Found.</div>"; }, 500);
        }

        // --- UPDATED: SECURE HOSTING ---
        async function handleAutoPublish() {
            const siteName = document.getElementById('pubSiteName').value.trim();
            const sourceFile = document.getElementById('pubFileName').value.trim();
            const resBox = document.getElementById('pubResult');
            
            if(!siteName || !sourceFile || /[^a-zA-Z0-9-]/.test(siteName)) { 
                showToast("Invalid Name! Use letters/numbers only."); return; 
            }
            const projectFiles = allFiles[currentProjectName];
            if(!projectFiles || !projectFiles[sourceFile]) { 
                resBox.innerHTML = `<span style="color:red;"> File '${sourceFile}' not found!</span>`; return; 
            }
            if(!ADMIN_CONFIG.token || ADMIN_CONFIG.token.length < 5) {
                resBox.innerHTML = `<span style="color:red;"> Server Config Error. Token missing.</span>`; return;
            }

            resBox.innerHTML = "<div class='spinner' style='width:30px;height:30px;border-width:3px;margin:0 auto;'></div><br>Encrypting & Publishing...";
            const { username, repo, token } = ADMIN_CONFIG;
            const targetFileName = siteName + ".html";
            
            const originalCode = projectFiles[sourceFile];
            const encryptedCode = window.btoa(unescape(encodeURIComponent(originalCode)));
            
            const secureHtml = `<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>${siteName}</title>
    <script>
        (function(){
            document.addEventListener('contextmenu', event => event.preventDefault());
            document.onkeydown = function(e) {
                if(e.keyCode == 123 || (e.ctrlKey && e.shiftKey && e.keyCode == 73)) return false;
            }
            setInterval(function(){ debugger; }, 100);
        })();
        window.onload = function() {
            var _sec = "${encryptedCode}";
            var _dec = decodeURIComponent(escape(window.atob(_sec)));
            document.open();
            document.write(_dec);
            document.close();
        };
    <\/script>
</head>
<body><div style="text-align:center;padding:50px;font-family:sans-serif;"> Loading Secure Site...</div></body>
</html>`;

            const contentBase64 = window.btoa(unescape(encodeURIComponent(secureHtml)));
            const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${targetFileName}`;

            try {
                let sha = null;
                const checkReq = await fetch(apiUrl, { headers: { 'Authorization': `token ${token}` } });
                if(checkReq.ok) {
                    const fileData = await checkReq.json();
                    sha = fileData.sha;
                    resBox.innerHTML = "Updating Secure Site...";
                } else {
                    resBox.innerHTML = "Creating Secure Site...";
                }

                const bodyData = { message: "Secure Publish: " + siteName, content: contentBase64 };
                if(sha) bodyData.sha = sha;

                const uploadReq = await fetch(apiUrl, { 
                    method: 'PUT', 
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(bodyData) 
                });

                if(uploadReq.ok) {
                    const liveUrl = `https://${username}.github.io/${repo}/${targetFileName}`;
                    
                    publishHistory = publishHistory.filter(h => h.link !== liveUrl);
                    publishHistory.unshift({ date: new Date().toLocaleString(), site: siteName, file: sourceFile, link: liveUrl });
                    saveData(); 
                    lastPublishedUrl = liveUrl;

                    resBox.innerHTML = `
                        <div style="margin-top:20px; animation: popIn 0.5s;">
                            <i class="fas fa-check-circle" style="color:#4CAF50; font-size:50px;"></i>
                            <h3 style="margin:10px 0; color:#4CAF50;">Published Securely!</h3>
                            <div style="background:#f0f0f0; padding:10px; border-radius:5px; font-size:12px; color:#555; word-break:break-all;">${liveUrl}</div>
                            <div style="display:flex; gap:10px; justify-content:center; margin-top:15px;">
                                <a href="${liveUrl}" target="_blank" class="copy-link-btn" style="background:#2196F3;">Open</a>
                                <button class="copy-link-btn" onclick="copyLink('${liveUrl}')">Copy</button>
                            </div>
                            <div style="margin-top:10px; color:red; font-size:10px; font-weight:bold;">
                                 Anti-Theft Protection Active
                            </div>
                        </div>`;
                    showToast("Site Encrypted & Published!");
                } else { 
                    const errData = await uploadReq.json();
                    resBox.innerHTML = `<span style='color:red;'>Error: ${errData.message}</span>`; 
                }
            } catch (error) { 
                console.error(error);
                resBox.innerHTML = `<span style='color:red;'>Connection Failed.</span>`; 
            }
        }

        // --- PUBLISH PAGE FUNCTIONS ---
        function openPublishPage() {
            if(!currentProjectName) {
                showToast("Please open a project first!");
                return;
            }
            hideAllPages();
            document.getElementById('publishPage').style.display = 'block';
            document.getElementById('bottomNav').style.display = 'none';
        }

        function closePublishPage() {
            document.getElementById('publishPage').style.display = 'none';
            document.getElementById('fileManagerPage').style.display = 'block';
        }

        function renderHistory() {
            const container = document.getElementById('historyListContainer'); container.innerHTML = "";
            if(publishHistory.length === 0) { container.innerHTML = '<p style="text-align:center;margin-top:50px;color:#999;">No history.</p>'; return; }
            publishHistory.forEach(item => {
                const div = document.createElement('div'); div.className = 'history-card';
                div.innerHTML = `<div class="h-header"><div class="h-site-name">${item.site}</div><div class="h-date">${item.date}</div></div><div class="h-file-name">Source: ${item.file}</div><div class="h-link-row"><div class="h-link-text">${item.link}</div><i class="fas fa-copy h-copy-icon" onclick="copyLink('${item.link}')"></i><a href="${item.link}" target="_blank" style="color:#2196F3;"><i class="fas fa-external-link-alt"></i></a></div>`;
                container.appendChild(div);
            });
        }

        // --- WEB TO APK LOGIC ---
        function webToApk() {
            if(!currentProjectName) {
                showToast("Please open a project first!");
                return;
            }
            hideAllPages();
            document.getElementById('webToApkPage').style.display = 'block';
            document.getElementById('bottomNav').style.display = 'none';
        }

        function closeWebToApk() {
            document.getElementById('webToApkPage').style.display = 'none';
            document.getElementById('fileManagerPage').style.display = 'block';
        }

        function triggerIconUpload() {
            document.getElementById('iconFileInput').click();
        }

        function handleIconUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('apkIconPreview').innerHTML = `<img src="${e.target.result}">`;
                    currentIconBase64 = e.target.result.split(',')[1];
                    console.log("Icon Loaded for Build");
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        function updateColorText(val) { document.getElementById('apkColorText').value = val; }
        function updateColorPicker(val) { document.getElementById('apkColorPicker').value = val; }

        async function triggerGitHubBuild() {
            const appName = document.getElementById('apkAppName').value;
            const pkgName = document.getElementById('apkPkgName').value;
            const fileName = document.getElementById('apkMainFile').value.trim();
            
            if(!appName || !fileName) { showToast("App Name and File Name required!"); return; }
            
            const projectFiles = allFiles[currentProjectName];
            if(!projectFiles || !projectFiles[fileName]) { 
                alert("File '" + fileName + "' not found in current project!"); 
                return; 
            }
            
            if(!ADMIN_CONFIG.token || ADMIN_CONFIG.token.length < 5) {
                alert("Server Config Error: Token Missing. Contact Admin."); 
                return;
            }

            const overlay = document.getElementById('buildOverlay');
            const status = document.getElementById('buildStatus');
            overlay.style.display = 'flex';
            
            const { username, repo, token } = ADMIN_CONFIG;

            async function uploadToRepo(path, contentBase64, msg) {
                const apiUrl = `https://api.github.com/repos/${username}/${repo}/contents/${path}`;
                let sha = null;
                try {
                    const checkReq = await fetch(apiUrl, { headers: { 'Authorization': `token ${token}` } });
                    if(checkReq.ok) {
                        const fileData = await checkReq.json();
                        sha = fileData.sha;
                    }
                } catch(e) {}

                const uploadBody = { message: msg, content: contentBase64 };
                if(sha) uploadBody.sha = sha;

                const uploadReq = await fetch(apiUrl, { 
                    method: 'PUT', 
                    headers: { 'Authorization': `token ${token}`, 'Content-Type': 'application/json' }, 
                    body: JSON.stringify(uploadBody) 
                });

                if(!uploadReq.ok) throw new Error("Failed to upload: " + path);
            }

            try {
                status.innerHTML = `
                    <div class="build-anim"><i class="fas fa-code fa-bounce"></i></div>
                    <div style="font-size:18px; font-weight:bold;">Uploading Code...</div>
                    <div style="font-size:12px; color:#ccc;">Preparing for Encryption</div>
                `;
            
                const userFolder = "apk_source/" + currentUser.uid;
                const htmlPath = userFolder + "/index.html";
                const iconPath = userFolder + "/icon.png";

                const htmlBase64 = window.btoa(unescape(encodeURIComponent(projectFiles[fileName])));
                await uploadToRepo(htmlPath, htmlBase64, "Upload Source: " + appName);

                let hasIcon = false;
                if(currentIconBase64) {
                    status.innerHTML = `
                        <div class="build-anim"><i class="fas fa-image fa-bounce"></i></div>
                        <div style="font-size:18px; font-weight:bold;">Uploading Icon...</div>
                    `;
                    await uploadToRepo(iconPath, currentIconBase64, "Upload Icon: " + appName);
                    hasIcon = true;
                }

                status.innerHTML = `
                    <div class="build-anim"><i class="fas fa-cog fa-spin"></i></div>
                    <div style="font-size:18px; font-weight:bold;">Starting Secure Build...</div>
                    <div style="font-size:12px; color:#ccc;">Encrypting & Compiling</div>
                `;

                const payload = {
                    event_type: "build_apk",
                    client_payload: {
                        app_name: appName,
                        package_name: pkgName,
                        source_path: htmlPath,
                        icon_path: iconPath,
                        has_custom_icon: hasIcon,
                        permissions: {
                            camera: document.getElementById('permCamera').checked,
                            mic: document.getElementById('permMic').checked,
                            location: document.getElementById('permLoc').checked,
                            storage: document.getElementById('permStorage').checked
                        },
                        config: {
                            fullscreen: document.getElementById('optFullscreen').checked,
                            hideTitle: document.getElementById('optHideTitle').checked,
                            orientation: document.getElementById('apkRotation').value
                        }
                    }
                };

                const req = await fetch(`https://api.github.com/repos/${username}/${repo}/dispatches`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify(payload)
                });

                if(req.status === 204) {
                    status.innerHTML = "Build Started!";
                    setTimeout(() => trackBuildStatus(username, repo, token), 5000);
                } else {
                    const errData = await req.json();
                    throw new Error("GitHub Error: " + (errData.message || "Unknown"));
                }

            } catch (e) {
                console.error(e);
                status.innerText = "Error: " + e.message;
                alert(e.message);
                setTimeout(() => overlay.style.display = 'none', 3000);
            }
        }

        async function trackBuildStatus(username, repo, token) {
            const status = document.getElementById('buildStatus');
            const apiUrl = `https://api.github.com/repos/${username}/${repo}/actions/runs`;
            
            let attempts = 0;
            const maxAttempts = 60;

            const interval = setInterval(async () => {
                attempts++;
                try {
                    const res = await fetch(apiUrl, { headers: { 'Authorization': `token ${token}` } });
                    const data = await res.json();
                    
                    if (data.workflow_runs && data.workflow_runs.length > 0) {
                        const latestRun = data.workflow_runs[0];
                        const animHTML = `
                            <div class="build-anim">
                                <i class="fas fa-cog fa-spin"></i>
                                <i class="fas fa-hammer hammer-icon"></i>
                            </div>`;

                        if (latestRun.status === 'queued') {
                            status.innerHTML = animHTML + '<div style="font-size:18px; font-weight:bold;">In Queue...</div><div style="font-size:12px; color:#ccc;">Server is busy</div>';
                        } 
                        else if (latestRun.status === 'in_progress') {
                            status.innerHTML = animHTML + '<div style="font-size:18px; font-weight:bold;">Building APK...</div><div style="font-size:12px; color:#ccc;">Injecting Icon & Plugins...</div>';
                        } 
                        else if (latestRun.status === 'completed') {
                            clearInterval(interval);
                            
                            if (latestRun.conclusion === 'success') {
                                status.innerHTML = '<i class="fas fa-box-open"></i> Finalizing...';
                                getDownloadLink(latestRun.artifacts_url, token);
                            } else {
                                status.innerHTML = '<span style="color:red"> Build Failed!</span><br><span style="font-size:12px">Check GitHub Actions logs.</span>';
                                setTimeout(() => document.getElementById('buildOverlay').style.display = 'none', 4000);
                            }
                        }
                    }
                } catch (e) {
                    console.log("Tracking error", e);
                }

                if (attempts >= maxAttempts) {
                    clearInterval(interval);
                    status.innerText = "Timeout: Build took too long.";
                    setTimeout(() => document.getElementById('buildOverlay').style.display = 'none', 4000);
                }
            }, 5000);
        }

        async function getDownloadLink(artifactsUrl, token) {
            const status = document.getElementById('buildStatus');
            try {
                const res = await fetch(artifactsUrl, { headers: { 'Authorization': `token ${token}` } });
                const data = await res.json();

                if (data.artifacts && data.artifacts.length > 0) {
                    const downloadUrl = "https://nightly.link/" + ADMIN_CONFIG.username + "/" + ADMIN_CONFIG.repo + "/actions/artifacts/" + data.artifacts[0].id + ".zip";
                    
                    status.innerHTML = `
                        <div style="text-align:center; animation: popIn 0.5s;">
                            <i class="fas fa-check-circle" style="font-size:60px; color:#3DDC84; margin-bottom:15px; display:block;"></i>
                            <h2 style="margin:0; color:white;">APK Ready!</h2>
                            <p style="font-size:12px; color:#ccc; margin-top:5px;">File is ready to install.</p>
                            <a href="${downloadUrl}" target="_blank" style="text-decoration:none;">
                                <button style="background:#3DDC84; color:black; font-weight:bold; padding:15px 30px; border-radius:50px; border:none; font-size:18px; margin-top:20px; cursor:pointer; box-shadow:0 0 20px rgba(61,220,132,0.4); display:flex; align-items:center; gap:10px;">
                                    <i class="fas fa-download"></i> DOWNLOAD APK
                                </button>
                            </a>
                            <br>
                            <button onclick="document.getElementById('buildOverlay').style.display='none'" style="background:transparent; border:1px solid #555; color:#aaa; padding:5px 15px; border-radius:20px; margin-top:10px; cursor:pointer;">Close</button>
                        </div>
                    `;
                } else {
                    status.innerText = "Error: Artifact not found.";
                }
            } catch (e) {
                status.innerText = "Error fetching link.";
            }
        }

        // ============================================
        // === NEW AI FEATURES (OpenRouter Integration) ===
        // ============================================

        function openAIModal() {
            const m = document.getElementById('aiModal');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
            if(m.style.display === 'flex') {
                document.getElementById('aiInput').focus();
            }
        }

    // === UPDATED AI FUNCTION (Date + Personality Fixed) ===
        async function sendToOpenRouter() {
            const inputEl = document.getElementById('aiInput');
            const chatBody = document.getElementById('aiChatBody');
            const prompt = inputEl.value.trim();
            
            if(!prompt) return;
            
            //  Check if Key is loaded
            if (!OPENROUTER_API_KEY) {
                alert("System Alert: AI API Key not configured by Admin.\nPlease contact support.");
                return;
            }
            
            // Add User Message
            const userMsg = document.createElement('div');
            userMsg.className = 'ai-msg ai-user';
            userMsg.innerText = prompt;
            chatBody.appendChild(userMsg);
            
            inputEl.value = "";
            chatBody.scrollTop = chatBody.scrollHeight;

            // Loading state
            const loadingMsg = document.createElement('div');
            loadingMsg.className = 'ai-msg ai-bot';
            loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Thinking...';
            chatBody.appendChild(loadingMsg);
            chatBody.scrollTop = chatBody.scrollHeight;

            try {
                //  GET CURRENT DATE & TIME
                const now = new Date().toLocaleString(); 

                // Using OpenRouter API
                const response = await fetch("https://openrouter.ai/api/v1/chat/completions", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${OPENROUTER_API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        "model": "deepseek/deepseek-chat", 
                        "messages": [
                            {
                                "role": "system",
                                //  DATE & PERSONALITY FIX 
                                "content": `Current Date & Time: ${now}. 
                                You are HopWeb AI, a smart and friendly coding assistant. 
                                
                                Rules:
                                1. Talk naturally like a human developer friend (Hinglish is okay).
                                2. If asked about time/date, use the 'Current Date' provided above.
                                3. If asked for code, provide ONLY the code wrapped in Markdown blocks.
                                4. Keep non-code answers short and helpful.`
                            },
                            {
                                "role": "user",
                                "content": prompt
                            }
                        ]
                    })
                });

                const data = await response.json();
                
                // Remove loading
                loadingMsg.remove();

                if(data.error) {
                    throw new Error(data.error.message);
                }

                const aiResponse = data.choices[0].message.content;
                
                // Add AI Message with Code Parsing
                const botDiv = document.createElement('div');
                botDiv.className = 'ai-msg ai-bot';
                
                // Basic Markdown Parsing
                let formattedHtml = "";
                if(typeof marked !== 'undefined') {
                    formattedHtml = marked.parse(aiResponse);
                } else {
                    formattedHtml = aiResponse.replace(/\n/g, "<br>");
                }

                botDiv.innerHTML = formattedHtml;
                
                // Add "Save Code" buttons
                const codeRegex = /```(\w*)\n([\s\S]*?)```/g;
                let match;
                while ((match = codeRegex.exec(aiResponse)) !== null) {
                    const lang = match[1] || 'html';
                    const code = match[2];
                    
                    const btn = document.createElement('button');
                    btn.className = 'save-code-btn';
                    btn.innerHTML = `<i class="fas fa-save"></i> Save as new ${lang} file`;
                    btn.onclick = function() { saveAICodeAsFile(code, lang); };
                    botDiv.appendChild(btn);
                }

                chatBody.appendChild(botDiv);
                chatBody.scrollTop = chatBody.scrollHeight;

            } catch (error) {
                loadingMsg.innerHTML = `<span style="color:red">Error: ${error.message}</span>`;
            }
        }
        function saveAICodeAsFile(code, type) {
            const fileName = prompt("Enter filename to save:", "ai_generated." + (type || "html"));
            if(fileName) {
                if(allFiles[currentProjectName][fileName]) {
                    alert("File exists! Choose another name.");
                    return;
                }
                allFiles[currentProjectName][fileName] = code;
                saveData();
                renderFiles();
                openAIModal(); // close chat
                showToast("File Saved!");
            }
        }

        // --- UTILS ---
        function copyLink(txt) { 
            if (navigator.clipboard && window.isSecureContext) navigator.clipboard.writeText(txt).then(() => showToast("Copied!")).catch(() => fallbackCopy(txt));
            else fallbackCopy(txt);
        }
        function fallbackCopy(txt) { const ta = document.createElement("textarea"); ta.value = txt; ta.style.position="fixed"; ta.style.left="-9999px"; document.body.appendChild(ta); ta.focus(); ta.select(); try { document.execCommand('copy'); showToast("Copied!"); } catch (e) {} document.body.removeChild(ta); }
        function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(()=> t.style.display='none', 3000); }
        function updateLineNumbers() { const editor = document.getElementById('codeEditor'); const lines = editor.value.split('\n').length; document.getElementById('lineNumbers').innerHTML = Array(lines).fill(0).map((_, i) => i + 1).join('<br>'); }
        function syncScroll() { document.getElementById('lineNumbers').scrollTop = document.getElementById('codeEditor').scrollTop; }
        function toggleEditorMenu() { const menu = document.getElementById('editorMenu'); menu.style.display = (menu.style.display === 'block') ? 'none' : 'block'; }
        function insertSymbol(sym) { const editor = document.getElementById('codeEditor'); const start = editor.selectionStart; const end = editor.selectionEnd; editor.value = editor.value.substring(0, start) + sym + editor.value.substring(end); editor.focus(); editor.selectionStart = editor.selectionEnd = start + sym.length; handleCodeInput(); }
        function ctxFind() { document.getElementById('editorMenu').style.display = 'none'; document.getElementById('findReplaceBar').style.display = 'block'; document.getElementById('findInput').focus(); }
        function closeFindBar() { document.getElementById('findReplaceBar').style.display = 'none'; }
        function findNext() { const e = document.getElementById('codeEditor'); const t = document.getElementById('findInput').value; if(!t) return; const txt = e.value; let p = txt.indexOf(t, e.selectionEnd); if(p === -1) p = txt.indexOf(t, 0); if(p !== -1) { e.focus(); e.setSelectionRange(p, p + t.length); e.scrollTop = (txt.substring(0, p).split('\n').length - 5) * 24; } else { showToast("Not Found"); } }
        function replaceOne() { const e = document.getElementById('codeEditor'); const r = document.getElementById('repInput').value; if(e.selectionStart !== e.selectionEnd) { const s = e.selectionStart; const txt = e.value; e.value = txt.substring(0, s) + r + txt.substring(e.selectionEnd); e.focus(); e.setSelectionRange(s, s + r.length); handleCodeInput(); } else { showToast("Select first"); } }
        function replaceAll() { const e = document.getElementById('codeEditor'); const t = document.getElementById('findInput').value; const r = document.getElementById('repInput').value; if(!t) return; const rx = new RegExp(t, 'g'); e.value = e.value.replace(rx, r); handleCodeInput(); showToast("Replaced All"); }
        function ctxFormat() { const e = document.getElementById('codeEditor'); e.value = e.value.split('\n').map(l => l.trim()).join('\n'); handleCodeInput(); document.getElementById('editorMenu').style.display = 'none'; }
        function ctxJump() { const l = prompt("Line:"); if(l) { document.getElementById('codeEditor').scrollTop = (parseInt(l) - 1) * 24; } document.getElementById('editorMenu').style.display = 'none'; }
        function ctxDoc() { showToast("Docs unavailable"); document.getElementById('editorMenu').style.display = 'none'; }
        function toggleSearch() { const s = document.getElementById('searchContainer'); s.style.display = (s.style.display === 'block') ? 'none' : 'block'; }
        function triggerImport() { document.getElementById('importFileInput').click(); }
        function filterFiles() { const q = document.getElementById('searchInput').value.toLowerCase(); document.querySelectorAll('.file-item').forEach(i => { const n = i.querySelector('.f-name').innerText.toLowerCase(); i.style.display = n.includes(q)?'flex':'none'; }); }
        function addLongPressEvent(el, callback) { let t; el.addEventListener('touchstart', () => { t = setTimeout(() => callback(), 800); }); el.addEventListener('touchend', () => clearTimeout(t)); el.addEventListener('mousedown', () => { t = setTimeout(() => callback(), 800); }); el.addEventListener('mouseup', () => clearTimeout(t)); }
        function openCreateModal() { document.getElementById('overlay').style.display = 'block'; document.getElementById('modalCreate').style.display = 'block'; }
        function closeModals() { document.getElementById('overlay').style.display = 'none'; document.querySelectorAll('.modal').forEach(m => m.style.display = 'none'); }
        function tryCloseEditor() { if(isCodeDirty) { document.getElementById('editorMenu').style.display = 'none'; document.getElementById('overlay').style.display = 'block'; document.getElementById('modalUnsaved').style.display = 'block'; } else { forceCloseEditor(); } }
        function saveAndExit() { saveCode(); closeModals(); forceCloseEditor(); }
        function discardAndExit() { setDirty(false); closeModals(); forceCloseEditor(); }
        function forceCloseEditor() { document.getElementById('editorMenu').style.display = 'none'; document.getElementById('editorPage').style.display = 'none'; document.getElementById('fileManagerPage').style.display = 'block'; document.getElementById('floatingDebugBtn').style.display = 'none'; document.getElementById('debugConsolePanel').style.display = 'none'; closeFindBar(); currentOpenedFile = ""; }
        function clearCache() { if(confirm("Delete ALL projects?")) { localStorage.clear(); location.reload(); } }
        
        function shareApp() { 
            const msg = "Try HopWeb Ultimate! Create, code and host websites directly from your phone. Download now: " + shareLink;
            const url = "https://api.whatsapp.com/send?text=" + encodeURIComponent(msg);
            window.open(url, '_blank');
        }

        function autoFix() { showToast("Auto-Fix Complete"); }
        function editSymbols() { prompt("Edit Symbols:", "{} <> ;"); showToast("Symbols Saved"); }
        
        function openCreateFileModal() {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('modalCreateFile').style.display = 'block';
            document.getElementById('newFileNameInput').value = "";
            document.getElementById('newFileNameInput').focus();
        }

        function performCreateFile() {
            var name = document.getElementById('newFileNameInput').value.trim();
            if(!name) { showToast("Enter a filename!"); return; }
            if(allFiles[currentProjectName][name]) { showToast("File already exists!"); return; }

            var content = "";
            if(name.endsWith(".html")) content = "\n<h1>" + name + "</h1>";
            else if(name.endsWith(".css")) content = "/* CSS File */\nbody { background: white; }";
            else if(name.endsWith(".js")) content = "// JS File\nconsole.log('Hello');";

            allFiles[currentProjectName][name] = content;
            saveData();
            renderFiles();
            closeModals();
            showToast("File Created!");
        }

    </script>
</body>
</html>